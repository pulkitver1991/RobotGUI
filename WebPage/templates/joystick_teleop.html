<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	
	<meta name="description" content="">
	
	<meta name="author" content="">
	
	<link rel="icon" href="static/images/aarg.png">
	
	<title>Robot Control</title>

	<!-- Load the Paper.js library -->
	<script type="text/javascript" src="static/js/paper-full.js"></script>

    <!-- Bootstrap core CSS -->
    <link href="static/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="static/dist/css/bootstrap4-toggle.min.css" rel="stylesheet">

    <!--Fonts-->
    <link href="static/css/fonts-all.css" rel="stylesheet">
    
    <!-- Icons -->
    <link href="static/css/font-awesome.css" rel="stylesheet">
    
    <!-- Custom styles for this template -->
    <link href="static/css/style.css" rel="stylesheet">

</head>

<body>
	<div class="container-fluid" id="wrapper">
		<div class="row">
			<nav class="sidebar col-xs-12 col-sm-4 col-lg-3 col-xl-2 bg-faded sidebar-style-1">
				<h1 class="site-title"><a href="/"><em class="fa fa-android"></em> Minion Control</a></h1>
				
				<a href="#menu-toggle" class="btn btn-default" id="menu-toggle"><em class="fa fa-bars"></em></a>
				
				<ul class="nav nav-pills flex-column sidebar-nav">
					<li class="nav-item"><a class="nav-link" href="/welcome"><em class="fa fa-home"></em> Welcome</a></li>
					<li class="nav-item"><a class="nav-link" href="/speed_control"><em class="fa fa-cogs"></em> Speed Control</a></li>
					<li class="nav-item"><a class="nav-link" href="/piston_control"><em class="fa fa-cogs"></em> Piston Control</a></li>
					<li class="nav-item"><a class="nav-link" href="/go_to_goal"><em class="fa fa-cogs"></em> Go To Goal</a></li>
					<li class="nav-item"><a class="nav-link" href="/human_control"><em class="fa fa-cogs"></em> Human Control</a></li>
					<li class="nav-item"><a class="nav-link active" href="/joystick_teleop"><em class="fa fa-cogs"></em> Joystick Teleop<span class="sr-only">(current)</span></a></li>
				</ul>
					
				<a href="/signout" class="logout-button"><em class="fa fa-power-off"></em> Signout</a></nav>
			
			<main class="col-xs-12 col-sm-8 offset-sm-4 col-lg-9 offset-lg-3 col-xl-10 offset-xl-2 pt-3 pl-4">
				<header class="page-header row justify-center">
					<div class="col-md-6 col-lg-8" >
						<h1 class="float-left text-center text-md-left">Joystick Tele-operation</h1>
					</div>
					
					<div class="dropdown user-dropdown col-md-6 col-lg-4 text-center text-md-right"><a class="btn btn-stripped dropdown-toggle" href="https://example.com" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						<img src="static/images/aarg.png" alt="profile photo" class="float-left img-fluid im-thumbnail" width="30" height="auto">
						
						<div class="username mt-1">
							<h4 class="mb-1">{{active_user}}</h4>
						</div>
						</a>
						
						<div class="dropdown-menu dropdown-menu-right" style="margin-right: 1.5rem;" aria-labelledby="dropdownMenuLink">
						     <a class="dropdown-item" href="/signout"><em class="fa fa-power-off mr-1"></em> Logout</a></div>
					</div>
					
					<div class="clear"></div>
				</header>

				
				<section class="row">
					<div class="row">
					<div class="col-sm-12 float-right" id="statusIndicator">
					    <p id="connecting">
					      Connecting to rosbridge...
					    </p>
					    <p id="connected" style="color:#00D600; display:none">
					      Connected
					    </p>
					    <p id="error" style="color:#FF0000; display:none">
					      Error in the backend!
					    </p>
					    <p id="closed" style="display:none">
					      Connection closed.
					    </p>
					</div>
					</div>
					<div class="col-sm-12">
						<section class="row">
							<div class="col-md-12 col-lg-9">
								<form id="myForm" class="form-horizontal" action="/human_control" method="post"> 
									<fieldset>
										<div class="form-group">
											<label for="rid" class="col"><strong>Select Robot</strong></label>
											<div class="row">
												<div class="col-sm-7">
													<div class="btn-group" data-toggle="buttons">
													{% for cnt in range(9) %}
														{% if cnt == 0 %}
													  	<label class="btn btn-primary active">
													    	<input type="radio" name="rid" id="option{{cnt}}" value="{{cnt}}" autocomplete="off" checked> {{cnt}}
													  	</label>
													  	{% else %}
													  	<label class="btn btn-primary">
													    	<input type="radio" name="rid" id="option{{cnt}}" value="{{cnt}}" autocomplete="off"> {{cnt}}
													  	</label>
													  	{% endif %}
													{% endfor %}
													</div>
												</div>
												<div class="col-sm-3 float-right">
  													<input type="text" id="move_command" class="form-control" placeholder="Input Command" onkeydown="myFunction(event)">
												</div>
												<div class="checkbox ml-auto">
												    <input id="track" type="checkbox" data-toggle="toggle" class="btn btn-primary float-right btn-sm" data-on="Track" data-off="Stop" data-offstyle="danger">
												</div>
											</div>
											<br>
											<div class="row">
												<div class="col-sm-7">
													<div class="jumbotron jumbotron-fluid">
													  <div class="container">
													    <h4 class="display-6">Joystick Controls</h4>
														    <p class="lead">To run the robot.<br>
										    				&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<font size="4"
		          											color="red">w</font><br>
										    				&nbsp; &nbsp; <font size="4"color="red">a</font> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<font size="4"color="red">d</font><br>
										    				&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  &nbsp; <font size="4"color="red">s</font> <br>
										    				Press "<font size="4"color="red">w</font>" to move Forward <br>
										    				Press "<font size="4"color="red">a</font>" to move Left <br>
										    				Press "<font size="4"color="red">d</font>" to move Right<br>
										    				Press "<font size="4"color="red">s</font>" to move Backward <br>
										    				Press "<font size="4"color="red">x/space</font>" to Stop the robot <br>
										    				</p>
													  </div>
													</div>
												</div>

												<div class="col-sm-5">
													<br>
													<br>
													<div class="card">
														<video class="float-left" width="550" controls>
												  		<source src="mov_bbb.mp4" type="video/mp4">
														</video>
													</div>
												</div>
											</div>
										</div>
									</fieldset>
								</form>	
							</div>
						</section>
					</div>
				</section>
			</main>
		</div>
	</div>

	<!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="static/js/jquery-3.2.1.min.js"></script>
    <script src="static/dist/js/bootstrap.min.js"></script>
    <!-- <script src="static/dist/js/bootstrap4-toggle.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
    <script src="static/js/bootstrap-datepicker.js"></script>
    <script src="static/js/custom.js"></script>
    <script src="static/js/tether.min.js"></script> 
	// <script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
	<script src="https://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
    <!-- Define inlined PaperScript associate it with myCanvas -->
    <script>
		// Connecting to ROS
		// -----------------
		var ros = new ROSLIB.Ros();

		// If there is an error on the backend, an 'error' emit will be emitted.
		ros.on('error', function(error) {
		    document.getElementById('connecting').style.display = 'none';
		    document.getElementById('connected').style.display = 'none';
		    document.getElementById('closed').style.display = 'none';
		    document.getElementById('error').style.display = 'inline';
		    console.log(error);
		});

		 // Find out exactly when we made a connection.
		 ros.on('connection', function() {
		    console.log('Connection made!');
		    document.getElementById('connecting').style.display = 'none';
		    document.getElementById('error').style.display = 'none';
		    document.getElementById('closed').style.display = 'none';
		    document.getElementById('connected').style.display = 'inline';
		});

	  	ros.on('close', function() {
		    console.log('Connection closed.');
		    document.getElementById('connecting').style.display = 'none';
		    document.getElementById('connected').style.display = 'none';
	    	document.getElementById('closed').style.display = 'inline';
 	 	});

	  	// Create a connection to the rosbridge WebSocket server.
	  	ros.connect('ws://localhost:9090');


	  	  // First, we create a Topic object with details of the topic's name and message type.
		  var cmdVel = new ROSLIB.Topic({
		    ros : ros,
		    name : '/cmd_vel',
		    messageType : 'geometry_msgs/Twist'
		  });

		  // Then we create the payload to be published. The object we pass in to ros.Message matches the
		  // fields defined in the geometry_msgs/Twist.msg definition.
		  var twist = new ROSLIB.Message({
		    linear : {
		      x : 0.0,
		      y : 0.0,
		      z : 0.0
		    },
		    angular : {
		      x : 0.0,
		      y : 0.0,
		      z : 0.0
		    }
		  });

	  	var joystick_pub = new ROSLIB.Topic({
	        ros : ros,
	        name : '/joystick_tracking',
	        messageType : 'std_msgs/Int8'
        });

        var joystick_status = new ROSLIB.Message({
        	data : 0.0    
        });

        // $("#move_command").keypress(function(event) {
        // 	var x =  event.which || event.keyCode;
        // 	if (x == 65){
        // 		console.log("hello");
        // 	}
        // });
		var send_cmd_vel = 0;
		var speed = 0, turn  = 0;

		function myFunction(event) {
		  var speed_dx = 0.05, turn_dx = 0.1;
		  var x = event.which || event.keyCode; // event.keyCode is used for IE8 and earlier
		  if (send_cmd_vel) {
			  if (x == 87) {  //w
			    speed = speed + speed_dx;
			  }

			  else if (x == 65) {  //a
			    turn = turn + turn_dx;
			  }

			  else if (x == 68) {  //d
			    turn = turn - turn_dx;
			  }

			  else if (x == 83) {  //s
			    speed = speed - speed_dx;
			  }

			  else if (x == 88 || x == 32) {  //x or spacebar
			    speed = 0;
			    turn = 0;
			  }
			  else{;}
			  [speed, turn] = limitVelocities(speed, turn);
		      twist.linear.x = speed;
		      twist.angular.z = turn;
		  	  cmdVel.publish(twist);	  
		  }
		  else{
		  	alert ("First Start the tracking process !!!");
			$('#move_command').val('');
		  }
		}


		function limitVelocities(speed, turn){
		  var speed_max = 0.3, turn_max = 3.14;	
		  if (speed > speed_max){speed = speed_max;}
		  if (speed < -speed_max){speed = -speed_max;}
		  if (turn > turn_max){turn = turn_max;}
		  if (turn < -turn_max){turn = -turn_max;}
		  return [speed, turn];
		}


  		$(function(){ 
  			$('#track').change(function() {
  				if($(this).prop('checked')) {
  					send_cmd_vel = 1;
  				} else {
  					send_cmd_vel = 0;
  					$('#move_command').val('');
  				}

  			});
  		});
    </script>

	</body>
</html>
